{% extends "base.html" %}
{% load static %}

{% block title %}Criar Oportunidade{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/criar_oportunidade.css' %}">
{% endblock %}

{% block content %}
<div class="opportunity-page">
    <header class="opportunity-header">
        {# O botão de voltar deve ter uma ação JS ou uma URL #}
        <a href="#" class="opportunity-back-button" onclick="history.back(); return false;" title="Voltar">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                <path d="M15 6L9 12L15 18" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </a>

        <h1 class="opportunity-header-title">Criar Oportunidade</h1>
        <p class="opportunity-header-subtitle">Conecte alunos com oportunidades acadêmicas criadas por você</p>
    </header>

    <form method="POST" enctype="multipart/form-data" class="opportunity-form">
        {% csrf_token %} 
        
        <div class="opportunity-container">
            
            {# Campo escondido que o Django Forms precisa para 'tipo' #}
            <input type="hidden" name="{{ form.tipo.name }}" id="{{ form.tipo.id_for_label }}" value="">

            {# ------------------ 1. TIPO DE OPORTUNIDADE (Botões) ------------------ #}
            <div class="form-group opportunity-type-group">
                <label class="opportunity-label">Tipo de atividade <span class="required">*</span></label>
                
                <div class="opportunity-activity-group">
                     {# Os valores de data-value devem coincidir com os choices do seu forms.py #}
                     <button type="button" class="opportunity-activity-btn" data-value="MON">Monitoria Acadêmica</button>
                     <button type="button" class="opportunity-activity-btn" data-value="IC">Iniciação Científica</button>
                     <button type="button" class="opportunity-activity-btn" data-value="EST">Estágio</button>
                     <button type="button" class="opportunity-activity-btn" data-value="LP">Laboratório de Pesquisa</button>
                     <button type="button" class="opportunity-activity-btn" data-value="TMP">Trabalho Meio Período</button>
                     <button type="button" class="opportunity-activity-btn" data-value="VOL">Voluntariado</button>
                     <button type="button" class="opportunity-activity-btn" data-value="PAL">Palestra</button>
                     <button type="button" class="opportunity-activity-btn" data-value="EQC">Equipe de Competição</button>
                     <button type="button" class="opportunity-activity-btn" data-value="BOL">Bolsa</button>
                     <button type="button" class="opportunity-activity-btn" data-value="OUT">Outro</button>
                </div>
                {# Mensagem de erro para o campo tipo #}
                {% for error in form.tipo.errors %}<span class="error-message">{{ error }}</span>{% endfor %}
            </div>
            
            {# ------------------ 2. TÍTULO E DESCRIÇÃO ------------------ #}
            <div class="form-group">
                <label class="opportunity-label" for="{{ form.titulo.id_for_label }}">Título <span class="required">*</span></label>
                {{ form.titulo }} 
                {% for error in form.titulo.errors %}<span class="error-message">{{ error }}</span>{% endfor %}
                <span class="char-counter">0/100</span>
            </div>

            <div class="form-group">
                <label class="opportunity-label" for="{{ form.descricao.id_for_label }}">Descrição <span class="required">*</span></label>
                {{ form.descricao }}
                {% for error in form.descricao.errors %}<span class="error-message">{{ error }}</span>{% endfor %}
                <span class="char-counter">0/5000</span>
            </div>

            {# ------------------ 3. IMAGEM DE CAPA ------------------ #}
            <div class="form-group">
                <label class="opportunity-label" for="{{ form.foto.id_for_label }}">Imagem de Capa (Opcional)</label>
                {{ form.foto }}
                {% for error in form.foto.errors %}<span class="error-message">{{ error }}</span>{% endfor %}
                <small class="opportunity-help-text">Se nenhuma imagem for enviada, um placeholder será exibido.</small>
            </div>
            
            {# ------------------ 4. CAMPOS RESTANTES (Individualmente ou com loop) ------------------ #}
            
            {% for field in form %}
                {% comment %} Renderiza os campos que não foram tratados acima e que não serão tratados abaixo {% endcomment %}
                {% if field.name != 'tipo' and field.name != 'titulo' and field.name != 'descricao' and field.name != 'foto' and field.name != 'data_encerramento' and field.name != 'cursos_elegiveis' and field.name != 'related_interests' %}
                    <div class="form-group">
                        <label class="opportunity-label" for="{{ field.id_for_label }}">{{ field.label }} {% if field.field.required %}<span class="required">*</span>{% endif %}</label>
                        {{ field }}
                        {% for error in field.errors %}<span class="error-message">{{ error }}</span>{% endfor %}
                    </div>
                {% endif %}
            {% endfor %}

            {# ------------------ 4.2. CURSOS ELEGÍVEIS (CheckboxSelectMultiple) ------------------ #}
            <div class="form-group form-group-checkbox-list">
                <label class="opportunity-label" for="{{ form.cursos_elegiveis.id_for_label }}">Cursos Elegíveis (Opcional)</label>
                <p class="opportunity-help-text">Selecione os cursos que podem se candidatar a esta oportunidade.</p>
                
                <div class="searchable-checkbox-container">
                    {# Searchbox para filtrar os cursos #}
                    <div class="checkbox-search-box">
                        <input type="text" class="search-input" id="search-cursos" placeholder="Buscar curso..." aria-label="Buscar curso elegível">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>

                    <div class="opportunity-cursos-container checkbox-grid" id="cursos-list">
                        {% for checkbox in form.cursos_elegiveis %}
                            <div class="opportunity-curso-item checkbox-item" data-filter-label="{{ checkbox.choice_label|lower }}">
                                {{ checkbox.tag }}
                                <label for="{{ checkbox.id_for_label }}" class="checkbox-label">
                                    {{ checkbox.choice_label }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                {% for error in form.cursos_elegiveis.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>
            
            {# ------------------ 4.5. INTERESSES RELACIONADOS (CheckboxSelectMultiple) ------------------ #}
            <div class="form-group form-group-checkbox-list">
                <label class="opportunity-label" for="{{ form.related_interests.id_for_label }}">Interesses Relacionados (Opcional)</label>
                <p class="opportunity-help-text">Marque os interesses que melhor descrevem esta oportunidade.</p>
                
                <div class="searchable-checkbox-container">
                    {# Searchbox para filtrar os interesses #}
                    <div class="checkbox-search-box">
                        <input type="text" class="search-input" id="search-interesses" placeholder="Buscar interesse..." aria-label="Buscar interesse relacionado">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>

                    <div class="opportunity-interesses-container checkbox-grid" id="interesses-list">
                        {% for checkbox in form.related_interests %}
                            <div class="opportunity-interesse-item checkbox-item" data-filter-label="{{ checkbox.choice_label|lower }}">
                                {{ checkbox.tag }}
                                <label for="{{ checkbox.id_for_label }}" class="checkbox-label">
                                    {{ checkbox.choice_label }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                {% for error in form.related_interests.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>
            
            {# ------------------ 5. DATA DE ENCERRAMENTO (Fim do Form) ------------------ #}
            <div class="form-group">
                <label class="opportunity-label" for="{{ form.data_encerramento.id_for_label }}">Data de encerramento do processo seletivo <span class="required">*</span></label>
                {{ form.data_encerramento }}
                {% for error in form.data_encerramento.errors %}<span class="error-message">{{ error }}</span>{% endfor %}
            </div>
            
            <button type="submit" class="opportunity-confirm">Confirmar</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const typeHiddenInput = document.getElementById('id_tipo');
        const activityGroup = document.querySelector('.opportunity-activity-group');
        const buttons = activityGroup ? activityGroup.querySelectorAll('.opportunity-activity-btn') : [];

        // Lógica visual e de valor para selecionar o botão
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                
                // Define o valor do input hidden com base no data-value do botão
                typeHiddenInput.value = btn.getAttribute('data-value');
            });

            // Lógica para manter o botão 'selected' se o valor do campo hidden já estiver preenchido
            if (typeHiddenInput.value && btn.getAttribute('data-value') === typeHiddenInput.value) {
                btn.classList.add('selected');
            }
        });

        // Adiciona a lógica de JavaScript para os contadores de caracteres
        const charCounterSetup = (textareaId, counterClass, maxLength) => {
            const element = document.getElementById(textareaId);
            const counter = element ? element.closest('.form-group').querySelector(counterClass) : null;

            if (element && counter) {
                const updateCounter = () => {
                    // Limita o texto ao comprimento máximo
                    if (element.value.length > maxLength) {
                        element.value = element.value.substring(0, maxLength);
                    }
                    counter.textContent = `${element.value.length}/${maxLength}`;
                };
                element.addEventListener('input', updateCounter);
                updateCounter(); // Contagem inicial
            }
        };

        // Aplica o contador para Título e Descrição
        charCounterSetup('id_titulo', '.char-counter', 100);
        charCounterSetup('id_descricao', '.char-counter', 5000);

        // ------------------ LÓGICA DE FILTRAGEM DE CHECKBOX (SEARCHBOX) ------------------

        const setupSearchFilter = (inputId, listId) => {
            const searchInput = document.getElementById(inputId);
            const listContainer = document.getElementById(listId);
            if (!searchInput || !listContainer) return;

            const items = listContainer.querySelectorAll('.checkbox-item');

            const filterItems = () => {
                const filter = searchInput.value.toLowerCase().trim();
                
                items.forEach(item => {
                    // Usa o data-filter-label que foi adicionado no HTML
                    const labelText = item.getAttribute('data-filter-label') || ''; 
                    
                    if (labelText.includes(filter)) {
                        item.style.display = 'flex'; // Mostra o item
                    } else {
                        item.style.display = 'none'; // Esconde o item
                    }
                });
            };

            searchInput.addEventListener('input', filterItems);
        };

        // Aplica o filtro de busca para Cursos
        setupSearchFilter('search-cursos', 'cursos-list');

        // Aplica o filtro de busca para Interesses
        setupSearchFilter('search-interesses', 'interesses-list');
    });
</script>
{% endblock %}