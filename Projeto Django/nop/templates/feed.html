{% extends 'base.html' %}
{% load static %}

{% block title %}Feed | NOP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/filtros.css' %}" />
<link rel="stylesheet" href="{% static 'css/feed.css' %}" />
{% endblock %}

{% block content %}
<nav class="barra-principal" role="navigation" aria-label="Menu principal">
    <div class="filtros-area">
        <div class="filtros-toggle" id="filtrosToggle">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
            <span>FILTROS</span>
        </div>
    </div>
    <div class="coluna-header">TIPO</div>
    <div class="coluna-header">CARGA HORÁRIA</div>
    <div class="coluna-header">REMUNERAÇÃO</div>
    <div class="coluna-header">HORAS COMP.</div>
    <div></div> 
</nav>

<div class="overlay" id="overlay"></div>

<div class="filter-modal" id="filterModal">
    <form method="GET" action="{% url 'feed' %}">
        
        <div class="filter-modal-header">
            <h2>Filtros</h2>
            <div class="close-filter" id="closeFilter">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="#031020" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            </div>
        </div>

        <div class="filter-content">
            
            <div class="filter-column">
                <h3>TIPO</h3>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="tipo" value="MON" {% if 'MON' in filtros_selecionados.tipos %}checked{% endif %}> Monitoria</label>
                    <label><input type="checkbox" name="tipo" value="EST" {% if 'EST' in filtros_selecionados.tipos %}checked{% endif %}> Estágio</label>
                    <label><input type="checkbox" name="tipo" value="IC" {% if 'IC' in filtros_selecionados.tipos %}checked{% endif %}> Iniciação Científica</label>
                    <label><input type="checkbox" name="tipo" value="TMP" {% if 'TMP' in filtros_selecionados.tipos %}checked{% endif %}> Trabalho Meio Período</label>
                    <label><input type="checkbox" name="tipo" value="VOL" {% if 'VOL' in filtros_selecionados.tipos %}checked{% endif %}> Voluntariado</label>
                    <label><input type="checkbox" name="tipo" value="PAL" {% if 'PAL' in filtros_selecionados.tipos %}checked{% endif %}> Palestra</label>
                    <label><input type="checkbox" name="tipo" value="EQC" {% if 'EQC' in filtros_selecionados.tipos %}checked{% endif %}> Equipe de Competição</label>
                    <label><input type="checkbox" name="tipo" value="BOL" {% if 'BOL' in filtros_selecionados.tipos %}checked{% endif %}> Bolsa</label>
                </div>
            </div>

            <div class="filter-column">
                <h3>CARGA HORÁRIA</h3>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="carga_horaria_check" value="compativel" {% if 'compativel' in filtros_selecionados.cargas %}checked{% endif %}> <strong>Compatível</strong></label>
                    <label><input type="checkbox" name="carga_horaria_check" value="<2" {% if '<2' in filtros_selecionados.cargas %}checked{% endif %}> &lt; 2 horas /dia</label>
                    <label><input type="checkbox" name="carga_horaria_check" value=">2" {% if '>2' in filtros_selecionados.cargas %}checked{% endif %}> &gt; 2 horas /dia</label>
                    <label><input type="checkbox" name="carga_horaria_check" value=">4" {% if '>4' in filtros_selecionados.cargas %}checked{% endif %}> &gt; 4 horas /dia</label>
                    <label><input type="checkbox" name="carga_horaria_check" value=">6" {% if '>6' in filtros_selecionados.cargas %}checked{% endif %}> &gt; 6 horas /dia</label>
                    <label><input type="checkbox" name="carga_horaria_check" value=">8" {% if '>8' in filtros_selecionados.cargas %}checked{% endif %}> &gt; 8 horas /dia</label>
                </div>
            </div>

            <div class="filter-column slider-column">
                <h3>REMUNERAÇÃO</h3>
                <div class="dual-slider-container">
                    <div class="slider-track"></div>
                    <div class="slider-range" id="rem-range-bar"></div>
                    
                    <div class="range-input">
                        <input type="range" id="min-rem" name="min_remuneracao" 
                               min="0" max="5000" step="50" 
                               value="{{ filtros_selecionados.min_remuneracao|default:'0' }}">
                               
                        <input type="range" id="max-rem" name="max_remuneracao" 
                               min="0" max="5000" step="50" 
                               value="{{ filtros_selecionados.max_remuneracao|default:'5000' }}">
                    </div>

                    <div class="slider-values">
                        <span id="display-min-rem">R$ 0</span>
                        <span id="display-max-rem">R$ 5000+</span>
                    </div>
                </div>
            </div>

            <div class="filter-column slider-column">
                <h3>HORAS COMP.</h3>
                <div class="dual-slider-container">
                    <div class="slider-track"></div>
                    <div class="slider-range" id="horas-range-bar"></div>
                    
                    <div class="range-input">
                        <input type="range" id="min-horas" name="min_horas" 
                               min="0" max="200" step="5" 
                               value="{{ filtros_selecionados.min_horas|default:'0' }}">
                               
                        <input type="range" id="max-horas" name="max_horas" 
                               min="0" max="200" step="5" 
                               value="{{ filtros_selecionados.max_horas|default:'200' }}">
                    </div>

                    <div class="slider-values">
                        <span id="display-min-horas">0h</span>
                        <span id="display-max-horas">200h</span>
                    </div>
                </div>
            </div>

            <div class="filter-column">
                <h3>INTERESSES</h3>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="interesses" value="meus" {% if 'meus' == filtros_selecionados.interesses %}checked{% endif %}> Meus interesses</label>
                    <label><input type="checkbox" name="interesses" value="tudo" {% if not filtros_selecionados.interesses or 'tudo' == filtros_selecionados.interesses %}checked{% endif %}> Tudo</label>
                </div>
            </div>

        </div>

        <div style="margin-top: 40px; text-align: right;">
            <a href="{% url 'feed' %}" style="margin-right: 20px; color: #666; text-decoration: none; font-size: 14px;">Limpar Filtros</a>
            <button type="submit" style="background: #031020; color: white; padding: 10px 30px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">
                APLICAR FILTROS
            </button>
        </div>
    </form>
</div>

<main class="feed" id="conteudo" role="main">
    {% for oportunidade in oportunidades %}
    <section class="oportunidade-item">

        <div class="oportunidade-col bookmark-col">
            {% if oportunidade.id %}
            <form method="post" action="{% url 'favoritar_oportunidade' oportunidade.id %}" id="fav-form-{{ oportunidade.id }}" class="fav-form-feed" style="display:inline;">
                {% csrf_token %}
                <button type="submit" style="display:none;"></button>
            </form>
            <a href="#" class="btn-favorito-link {% if oportunidade.id in favoritos_ids %}favorito{% endif %}" data-form-id="fav-form-{{ oportunidade.id }}">
                <svg class="heart-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </a>
            {% endif %}
        </div>

        <div class="oportunidade-col info-col">
            <div class="info-imagem" style="background-image: url('https://via.placeholder.com/60x60/333/666?text={{ oportunidade.titulo|slice:":1" }}');"></div>
            <div class="info-texto">
                <h3>{{ oportunidade.titulo }}</h3>
                <p>{{ oportunidade.area }}</p>
            </div>
        </div>

        <div class="oportunidade-col">{{ oportunidade.get_tipo_display }}</div>
        <div class="oportunidade-col">{{ oportunidade.carga_horaria }}</div>
        <div class="oportunidade-col">R$ {{ oportunidade.remuneracao }}</div>
        <div class="oportunidade-col">{{ oportunidade.horas_complementares }}h</div>

        <div class="oportunidade-col acao-col">
            <a href="{% url 'detalhe_oportunidade' oportunidade.id %}" class="btn-ver-mais">Ver mais</a>
        </div>

    </section>
    {% empty %}
        <p style="text-align: center; padding: 40px; color: #99a8bd;">Nenhuma oportunidade encontrada com esses filtros.</p>
    {% endfor %}
</main>
{% endblock %}

{% block extra_js %}
<script>
    // --- Controle do Modal ---
    const filtrosToggle = document.getElementById("filtrosToggle");
    const overlay = document.getElementById("overlay");
    const filterModal = document.getElementById("filterModal");
    const closeFilter = document.getElementById("closeFilter");

    function openFilterModal() {
        if(overlay && filterModal) {
            overlay.style.display = "block";
            filterModal.style.display = "block";
            document.body.style.overflow = "hidden";
        }
    }

    function closeFilterModal() {
        if(overlay && filterModal) {
            overlay.style.display = "none";
            filterModal.style.display = "none";
            document.body.style.overflow = "";
        }
    }

    if(filtrosToggle) filtrosToggle.addEventListener('click', openFilterModal);
    if(closeFilter) closeFilter.addEventListener('click', closeFilterModal);
    if(overlay) overlay.addEventListener('click', closeFilterModal);

    // --- Script de Favoritar ---
    document.addEventListener('DOMContentLoaded', function() {
        const salvarLinks = document.querySelectorAll('.btn-favorito-link');
        salvarLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault(); 
                const formId = this.getAttribute('data-form-id');
                const form = document.getElementById(formId);
                if (form) form.submit();
            });
        });
    });

    // ===============================================
    // LÓGICA DO DUAL SLIDER (2 PONTAS)
    // ===============================================
    function initDualSlider(minInputId, maxInputId, rangeBarId, displayMinId, displayMaxId, prefix, suffix) {
        const minInput = document.getElementById(minInputId);
        const maxInput = document.getElementById(maxInputId);
        const rangeBar = document.getElementById(rangeBarId);
        const dMin = document.getElementById(displayMinId);
        const dMax = document.getElementById(displayMaxId);
        const gap = 0; // Diferença mínima entre os dois cursores

        function updateSlider() {
            let minVal = parseInt(minInput.value);
            let maxVal = parseInt(maxInput.value);

            // Impede que a bolinha MIN ultrapasse a MAX
            if (maxVal - minVal < gap) {
                if (this === minInput) {
                    minInput.value = maxVal - gap;
                } else {
                    maxInput.value = minVal + gap;
                }
            }
            
            // Atualiza os textos visuais
            dMin.textContent = prefix + minInput.value + suffix;
            dMax.textContent = prefix + maxInput.value + suffix;

            // Calcula a posição e largura da barra colorida
            const max = parseInt(maxInput.max);
            const percentMin = (minInput.value / max) * 100;
            const percentMax = (maxInput.value / max) * 100;

            rangeBar.style.left = percentMin + "%";
            rangeBar.style.width = (percentMax - percentMin) + "%";
        }

        // Ouve mudanças enquanto arrasta
        minInput.addEventListener("input", updateSlider);
        maxInput.addEventListener("input", updateSlider);
        
        // Executa uma vez ao carregar para posicionar corretamente (usando os valores do Django)
        updateSlider();
    }

    // Inicializa quando a página carregar
    document.addEventListener("DOMContentLoaded", function() {
        // Slider de Remuneração
        initDualSlider("min-rem", "max-rem", "rem-range-bar", "display-min-rem", "display-max-rem", "R$ ", "");
        
        // Slider de Horas Complementares
        initDualSlider("min-horas", "max-horas", "horas-range-bar", "display-min-horas", "display-max-horas", "", "h");
    });
</script>
{% endblock %}