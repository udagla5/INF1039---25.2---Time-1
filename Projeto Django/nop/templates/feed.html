{% extends 'base.html' %}
{% load static %}

{% block title %}Feed | NOP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/filtros.css' %}" />
<link rel="stylesheet" href="{% static 'css/feed.css' %}" />
{% endblock %}

{% block content %}
<nav class="barra-principal" role="navigation" aria-label="Menu principal">
    <div class="filtros-area">
        <div class="filtros-toggle" id="filtrosToggle">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
            <span>FILTROS</span>
        </div>
    </div>
    <div class="coluna-header">TIPO</div>
    <div class="coluna-header">CARGA HOR√ÅRIA</div>
    <div class="coluna-header">REMUNERA√á√ÉO</div>
    <div class="coluna-header">HORAS COMP.</div>
    <div></div> </nav>

<div class="overlay" id="overlay"></div>

<div class="filter-modal" id="filterModal">
    <div class="filter-modal-header">
        <h2>Filtros</h2>
        <div class="close-filter" id="closeFilter">‚úñ</div>
    </div>

    <div class="filter-content">
        <div class="filter-column">
            <h3>TIPO</h3>
            <label><input type="checkbox"> Monitoria</label>
            <label><input type="checkbox"> Est√°gio</label>
            <label><input type="checkbox"> Inicia√ß√£o Cient√≠fica</label>
            <label><input type="checkbox"> Trabalho Meio Per√≠odo</label>
            <label><input type="checkbox"> Voluntariado</label>
            <label><input type="checkbox"> Palestra</label>
            <label><input type="checkbox"> Equipe de Competi√ß√£o</label>
            <label><input type="checkbox"> Bolsa</label>
        </div>

        <div class="filter-column">
            <h3>CARGA HOR√ÅRIA</h3>
            <label><input type="checkbox"> &lt; 2 horas /dia</label>
            <label><input type="checkbox"> &gt; 2 horas /dia</label>
            <label><input type="checkbox"> &gt; 4 horas /dia</label>
            <label><input type="checkbox"> &gt; 6 horas /dia</label>
            <label><input type="checkbox"> &gt; 8 horas /dia</label>
        </div>

        <div class="filter-column">
            <h3>REMUNERA√á√ÉO</h3>
            <input type="range">
        </div>

        <div class="filter-column">
            <h3>HORAS COMP.</h3>
            <input type="range">
        </div>

        <div class="filter-column">
            <h3>INTERESSES</h3>
            <label><input type="checkbox"> Meus interesses</label>
            <label><input type="checkbox"> Tudo</label>
        </div>
    </div>
</div>

<main class="feed" id="conteudo" role="main">
    {% for oportunidade in oportunidades %}
    <section class="oportunidade-item">

        <div class="oportunidade-col bookmark-col">
            {% if oportunidade.id %}
            
            <form method="post" action="{% url 'favoritar_oportunidade' oportunidade.id %}" id="fav-form-{{ oportunidade.id }}" class="fav-form-feed" style="display:inline;">
                {% csrf_token %}
                <button type="submit" style="display:none;"></button>
            </form>
            
            <a href="#" 
               class="btn-favorito-link {% if oportunidade.id in favoritos_ids %}favorito{% endif %}" 
               data-form-id="fav-form-{{ oportunidade.id }}" 
               aria-label="Salvar {{ oportunidade.titulo }}">
                <svg class="heart-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </a>
            
            {% else %}
            <a href="#" class="btn-favorito-link" disabled aria-label="Salvar indispon√≠vel">
                <svg class="heart-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </a>
            {% endif %}
        </div>

        <div class="oportunidade-col info-col">
            <div class="info-imagem" style="background-image: url('https://via.placeholder.com/60x60/333/666?text={{ oportunidade.titulo|slice:":1" }}');"></div>
            <div class="info-texto">
                <h3>{{ oportunidade.titulo }}</h3>
                <p>{{ oportunidade.area }}</p>
            </div>
        </div>

        <div class="oportunidade-col">{{ oportunidade.get_tipo_display }}</div>
        <div class="oportunidade-col">{{ oportunidade.carga_horaria }}</div>
        <div class="oportunidade-col">R$ {{ oportunidade.remuneracao }}</div>
        <div class="oportunidade-col">{{ oportunidade.horas_complementares }}h</div>

        <div class="oportunidade-col acao-col">
            <a href="{% url 'detalhe_oportunidade' oportunidade.id %}" class="btn-ver-mais">
                Ver mais
            </a>
        </div>

    </section>
    {% empty %}
        <p style="text-align: center; padding: 40px; color: #99a8bd;">Nenhuma oportunidade encontrada.</p>
    {% endfor %}
</main>
{% endblock %}

{% block extra_js %}
<script>
    // Seletores
    const filtrosToggle = document.getElementById("filtrosToggle");
    const overlay = document.getElementById("overlay");
    const filterModal = document.getElementById("filterModal");
    const closeFilter = document.getElementById("closeFilter");

    function openFilterModal() {
        if(overlay && filterModal) {
            overlay.style.display = "block";
            filterModal.style.display = "block";
            document.body.style.overflow = "hidden";
        }
    }

    function closeFilterModal() {
        if(overlay && filterModal) {
            overlay.style.display = "none";
            filterModal.style.display = "none";
            document.body.style.overflow = "";
        }
    }

    // Event listeners para o Modal
    if (filtrosToggle) filtrosToggle.addEventListener('click', openFilterModal);
    if (closeFilter) closeFilter.addEventListener('click', closeFilterModal);
    if (overlay) overlay.addEventListener('click', closeFilterModal);

    // Fechar com ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && overlay && overlay.style.display === 'block') {
            closeFilterModal();
        }
    });

    // üöÄ NOVO SCRIPT PARA SALVAR VIA LINK (FEED)
    document.addEventListener('DOMContentLoaded', function() {
        const salvarLinks = document.querySelectorAll('.btn-favorito-link');
        
        salvarLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault(); // Impede o link de navegar
                const formId = this.getAttribute('data-form-id');
                const form = document.getElementById(formId);
                
                if (form) {
                    form.submit(); // Envia o formul√°rio correspondente
                }
            });
        });
    });
</script>
{% endblock %}