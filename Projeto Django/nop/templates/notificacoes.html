{% extends 'base.html' %}
{% load static %}

{% block title %}Notifica√ß√µes | NOP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/notificacoes.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
{% endblock %}

{% block content %}
<div class="notifications-wrapper">

    <div class="notifications-header">
        <h2 class="page-title">Notifica√ß√µes</h2>
        <div class="notifications-actions">
            {% if nao_lidas > 0 %}
                <a href="{% url 'marcar_todas_lidas' %}" class="btn-action" title="Marcar todas como lidas">
                    <i class="fas fa-check-double"></i> Marcar todas como lidas
                </a>
            {% endif %}
            <a href="{% url 'limpar_notificacoes' %}" class="btn-action btn-danger" title="Limpar notifica√ß√µes lidas" onclick="return confirm('Deseja remover todas as notifica√ß√µes lidas?')">
                <i class="fas fa-trash"></i> Limpar lidas
            </a>
        </div>
    </div>

    {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if nao_lidas > 0 %}
        <div class="notifications-summary">
            <i class="fas fa-bell"></i> Voc√™ tem <strong>{{ nao_lidas }}</strong> notifica√ß√£o(√µes) n√£o lida(s)
        </div>
    {% endif %}

    <div class="notifications-list" id="notificationsList">
        {% if notificacoes %}
            {% for notificacao in notificacoes %}
                <div class="notification-item {% if not notificacao.lida %}unread{% endif %}" data-id="{{ notificacao.id }}">
                    <div class="notification-icon">
                        {% if 'mensagem' in notificacao.mensagem|lower %}
                            üí¨
                        {% elif 'oportunidade' in notificacao.mensagem|lower %}
                            üìå
                        {% elif 'atualiza√ß√£o' in notificacao.mensagem|lower %}
                            üîî
                        {% elif 'encerrada' in notificacao.mensagem|lower %}
                            ‚è∞
                        {% elif 'vagas' in notificacao.mensagem|lower %}
                            üéØ
                        {% else %}
                            üîî
                        {% endif %}
                    </div>
                    <div class="notification-content">
                        <p class="notification-text">{{ notificacao.mensagem }}</p>
                        <span class="notification-time">{{ notificacao.data|timesince }} atr√°s</span>
                    </div>
                    <div class="notification-actions">
                        {% if not notificacao.lida %}
                            <button class="btn-mark-read" onclick="marcarComoLida({{ notificacao.id }})" title="Marcar como lida">
                                <i class="fas fa-check"></i>
                            </button>
                        {% endif %}
                        <a href="{% url 'deletar_notificacao' notificacao.id %}" class="btn-delete" title="Remover" onclick="return confirm('Deseja remover esta notifica√ß√£o?')">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="no-notifications">
                <i class="fas fa-bell-slash" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                <p>Voc√™ n√£o tem notifica√ß√µes no momento.</p>
            </div>
        {% endif %}
    </div>

</div>

<script>
function marcarComoLida(notificacaoId) {
    fetch(`/notificacoes/marcar-lida/${notificacaoId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const item = document.querySelector(`.notification-item[data-id="${notificacaoId}"]`);
            if (item) {
                item.classList.remove('unread');
                const btnMarkRead = item.querySelector('.btn-mark-read');
                if (btnMarkRead) {
                    btnMarkRead.remove();
                }
            }
            // Recarrega a p√°gina para atualizar o contador
            setTimeout(() => location.reload(), 500);
        }
    })
    .catch(error => console.error('Erro:', error));
}

// Marcar como lida ao clicar na notifica√ß√£o
document.addEventListener("DOMContentLoaded", () => {
    const list = document.getElementById("notificationsList");

    if (!list) return;

    list.addEventListener("click", (event) => {
        const item = event.target.closest(".notification-item");
        if (!item) return;

        // N√£o marcar como lida se clicar nos bot√µes de a√ß√£o
        if (event.target.closest('.notification-actions')) return;

        const notificacaoId = item.getAttribute('data-id');
        
        if (item.classList.contains("unread")) {
            marcarComoLida(notificacaoId);
        }
    });
});
</script>
{% endblock %}
