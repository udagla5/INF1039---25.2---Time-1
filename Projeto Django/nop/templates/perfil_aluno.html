{% extends "base.html" %}
{% load static %}

{% block title %}Editar Perfil | NOP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/perfil_aluno_style.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
    /* Garante que a foto de perfil fique redonda e não esticada */
    .profile-avatar-img, .profile-modal-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    /* Remove estilos conflitantes se houver */
    .profile-edit-container .profile-avatar {
        width: auto !important; height: auto !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-edit-container">
    <header class="profile-edit-header">
        <div class="profile-header-content">
            <div class="profile-header-text">
                <h1>Editar Perfil</h1>
                <p>Configure a sua experiência NOP</p>
            </div>
        </div>
    </header>

    <main class="profile-edit-main">
        <div class="profile-avatar-section">
            <div class="profile-avatar-large">
                
                {% if user.foto_perfil %}
                    <img src="{{ user.foto_perfil.url }}" alt="Foto de perfil" class="profile-avatar-img">
                {% else %}
                    <div class="profile-default-avatar">
                        {{ user.get_full_name|default:user.username|first|upper }}
                    </div>
                {% endif %}
                
                <button class="profile-edit-avatar-btn" aria-label="Editar Foto de Perfil">
                    <i class="fa-solid fa-camera"></i>
                </button>
            </div>
        </div>

        <div class="profile-edit-form-box">
            <form class="profile-edit-form" method="POST">
                {% csrf_token %}
                
                <div class="profile-form-section">
                    <h3 class="profile-section-title">Informações Pessoais</h3>
                    
                    <div class="profile-form-group">
                        <label for="username">Seu username</label>
                        <input type="text" id="username" name="username" value="{{ user.username }}">
                    </div>

                    <div class="profile-form-group">
                        <label for="email-institucional">Email institucional</label>
                        <input type="email" id="email-institucional" name="email-institucional" value="{{ user.email }}">
                    </div>

                    <div class="profile-form-group">
                        <label for="telefone">Telefone</label>
                        <input type="tel" id="telefone" name="telefone" placeholder="(21) 99999-9999" onkeyup="formatPhone(this)">
                    </div>
                </div>

                <div class="profile-section-divider"></div>

                <div class="profile-form-section">
                    <h3 class="profile-section-title">Segurança</h3>
                    <div class="profile-form-group profile-password-group">
                        <label>Senha atual</label>
                        <input type="password" id="senhaAntigaInput" name="senha-antiga" placeholder="Digite a sua senha atual">
                        <button type="button" class="profile-toggle-password-btn" id="toggleSenhaAntiga"><i class="fa-solid fa-eye-slash"></i></button>
                    </div>

                    <div class="profile-form-group profile-password-group">
                        <label>Nova senha</label>
                        <input type="password" id="senhaNovaInput" name="senha-nova" placeholder="Digite a sua nova senha">
                        <button type="button" class="profile-toggle-password-btn" id="toggleSenhaNova"><i class="fa-solid fa-eye-slash"></i></button>
                    </div>
                </div>

                <div class="profile-section-divider"></div>

                <button type="submit" class="profile-confirm-btn">Confirmar mudanças</button>
            </form>
        </div>
    </main>
</div>

<div id="avatarEditModal" class="profile-modal">
    <div class="profile-modal-content">
        <span class="profile-modal-close-btn">&times;</span>
        <h3 class="profile-modal-title">Sua Foto de Perfil</h3>

        <form id="avatarUploadForm" method="POST" enctype="multipart/form-data" action="{% url 'upload_avatar' %}">
            {% csrf_token %}

            <div class="profile-modal-avatar-preview">
                {% if user.foto_perfil %}
                    <img id="modalAvatarPreviewImg" src="{{ user.foto_perfil.url }}" alt="Prévia" class="profile-modal-img">
                {% else %}
                    <div id="modalAvatarPreviewDefault" class="profile-modal-default-avatar">
                        {{ user.get_full_name|default:user.username|first|upper }}
                    </div>
                {% endif %}
            </div>

            <input type="file" id="avatarFileInput" name="avatar" accept="image/*" style="display: none;">
            
            <button type="button" id="changeImageBtn" class="profile-modal-action-btn">Alterar Imagem</button>
            <button type="submit" id="saveImageBtn" class="profile-confirm-btn" style="display: none; margin-top: 15px;">Salvar Foto</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Formatação de telefone
    function formatPhone(input) {
        let value = input.value.replace(/\D/g, "");
        let formattedValue = '';
        if (value.length > 0) formattedValue = '(' + value.substring(0, 2);
        if (value.length > 2) formattedValue += ') ' + value.substring(2, 7);
        if (value.length > 7) formattedValue += '-' + value.substring(7, 11);
        input.value = formattedValue.substring(0, 15);
    }

    // Toggle de senha
    function setupPasswordToggle(toggleId, inputId) {
        const toggleButton = document.getElementById(toggleId);
        const passwordInput = document.getElementById(inputId);
        if(toggleButton && passwordInput){
            toggleButton.addEventListener('click', function() {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                const icon = this.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
        }
    }
    setupPasswordToggle('toggleSenhaAntiga', 'senhaAntigaInput');
    setupPasswordToggle('toggleSenhaNova', 'senhaNovaInput');

    // MODAL DE UPLOAD
    const modal = document.getElementById('avatarEditModal');
    const btnCamera = document.querySelector('.profile-edit-avatar-btn');
    const spanClose = document.querySelector('.profile-modal-close-btn');
    const avatarFileInput = document.getElementById('avatarFileInput');
    const changeImageBtn = document.getElementById('changeImageBtn');
    const saveImageBtn = document.getElementById('saveImageBtn');
    const avatarPreviewContainer = document.querySelector('.profile-modal-avatar-preview');

    if(btnCamera) {
        btnCamera.addEventListener('click', () => { 
            modal.style.display = 'block'; 
            saveImageBtn.style.display = 'none';
        });
    }
    if(spanClose) {
        spanClose.addEventListener('click', () => { modal.style.display = 'none'; });
    }
    window.addEventListener('click', (event) => {
        if (event.target == modal) modal.style.display = 'none';
    });

    if(changeImageBtn) {
        changeImageBtn.addEventListener('click', () => avatarFileInput.click());
    }

    if(avatarFileInput) {
        avatarFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let defaultAvatar = document.getElementById('modalAvatarPreviewDefault');
                    if (defaultAvatar) defaultAvatar.remove();

                    let imgElement = document.getElementById('modalAvatarPreviewImg');
                    if (!imgElement) {
                        imgElement = document.createElement('img');
                        imgElement.id = 'modalAvatarPreviewImg';
                        imgElement.classList.add('profile-modal-img');
                        avatarPreviewContainer.appendChild(imgElement);
                    }
                    imgElement.src = e.target.result;
                    saveImageBtn.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }
</script>
{% endblock %}