{% extends "base.html" %}
{% load static %}

{% block title %}Editar Perfil | NOP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/perfil_aluno_style.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
    /* Reset específico para evitar conflitos com o header do base.css */
    .profile-edit-container .profile-avatar,
    .profile-edit-container .edit-avatar-btn {
        width: auto !important;
        height: auto !important;
        border-radius: 0 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-edit-container">
    <header class="profile-edit-header">
        <div class="profile-header-content">
            <div class="profile-header-text">
                <h1>Editar Perfil</h1>
                <p>Configure a sua experiência NOP</p>
            </div>
        </div>
    </header>

    <main class="profile-edit-main">
        <div class="profile-avatar-section">
            <div class="profile-avatar-large">
                {% if user.profile.avatar %}
                    <img src="{{ user.profile.avatar.url }}" alt="Foto de perfil" class="profile-avatar-img">
                {% elif user.avatar %}
                    <img src="{{ user.avatar.url }}" alt="Foto de perfil" class="profile-avatar-img">
                {% else %}
                    <div class="profile-default-avatar">
                        {{ user.get_full_name|default:user.username|first|upper }}
                    </div>
                {% endif %}
                <button class="profile-edit-avatar-btn" aria-label="Editar Foto de Perfil">
                    <i class="fa-solid fa-camera"></i>
                </button>
            </div>
        </div>

        <div class="profile-edit-form-box">
            <form class="profile-edit-form" method="POST">
                {% csrf_token %}
                
                <!-- Seção 1: Informações Pessoais -->
                <div class="profile-form-section">
                    <h3 class="profile-section-title">Informações Pessoais</h3>
                    
                    <div class="profile-form-group">
                        <label for="username">Seu username</label>
                        <input type="text" id="username" name="username" value="{{ user.username }}">
                    </div>

                    <div class="profile-form-group">
                        <label for="email-institucional">Email institucional</label>
                        <input type="email" id="email-institucional" name="email-institucional" value="{{ user.email }}">
                    </div>

                    <div class="profile-form-group">
                        <label for="email-secundario">Email institucional secundário</label>
                        <input type="email" id="email-secundario" name="email-secundario" placeholder="seu.nome@aluno.puc-rio.br">
                    </div>

                    <div class="profile-form-group">
                        <label for="telefone">Telefone</label>
                        <input 
                            type="tel" 
                            id="telefone" 
                            name="telefone" 
                            placeholder="(21) 99999-9999"
                            pattern="(\([0-9]{2}\)\s)?[0-9]{4,5}-[0-9]{4}"
                            maxlength="15"
                            onkeypress="return isNumberKey(event)"
                            onkeyup="formatPhone(this)">
                    </div>
                </div>

                <!-- Separador visual -->
                <div class="profile-section-divider"></div>

                <!-- Seção 2: Segurança -->
                <div class="profile-form-section">
                    <h3 class="profile-section-title">Segurança</h3>
                    
                    <div class="profile-form-group profile-password-group">
                        <label for="senhaAntigaInput">Senha atual</label>
                        <input type="password" id="senhaAntigaInput" name="senha-antiga" placeholder="Digite a sua senha atual">
                        <button type="button" class="profile-toggle-password-btn" id="toggleSenhaAntiga">
                            <i class="fa-solid fa-eye-slash"></i>
                        </button>
                    </div>

                    <div class="profile-form-group profile-password-group">
                        <label for="senhaNovaInput">Nova senha</label>
                        <input type="password" id="senhaNovaInput" name="senha-nova" placeholder="Digite a sua nova senha">
                        <button type="button" class="profile-toggle-password-btn" id="toggleSenhaNova">
                            <i class="fa-solid fa-eye-slash"></i>
                        </button>
                    </div>
                </div>

                <!-- Separador visual -->
                <div class="profile-section-divider"></div>

                <!-- Seção 3: Interesses -->
                <div class="profile-form-section">
                    <h3 class="profile-section-title">Interesses</h3>
                    <p class="profile-section-description">Selecione os seus interesses</p>
                        
                    <div class="profile-interests-grid">
                        <button type="button" class="profile-interest-tag">Design Gráfico</button>
                        <button type="button" class="profile-interest-tag">Programação</button>
                        <button type="button" class="profile-interest-tag">Sustentabilidade</button>
                        <button type="button" class="profile-interest-tag">Inteligência Artificial</button>
                        <button type="button" class="profile-interest-tag">Mercado Financeiro</button>
                        <button type="button" class="profile-interest-tag">Comunicação</button>
                        <button type="button" class="profile-interest-tag">UX/UI</button>
                        <button type="button" class="profile-interest-tag">Engenharia de Software</button>
                        <button type="button" class="profile-interest-tag">Biologia Marinha</button>
                        <button type="button" class="profile-interest-tag">Análise de Dados</button>
                        <button type="button" class="profile-interest-tag">Marketing</button>
                        <button type="button" class="profile-interest-tag">Artes Cênicas</button>
                        <button type="button" class="profile-interest-tag">Gestão de Projetos</button>
                        <button type="button" class="profile-interest-tag">Línguas</button>
                    </div>
                </div>

                <button type="submit" class="profile-confirm-btn">Confirmar mudanças</button>
            </form>
        </div>
    </main>
</div>

<div id="avatarEditModal" class="profile-modal">
    <div class="profile-modal-content">
        <span class="profile-modal-close-btn">&times;</span>
        
        <h3 class="profile-modal-title">Sua Foto de Perfil</h3>

        <form id="avatarUploadForm" method="POST" enctype="multipart/form-data" action="{% url 'upload_avatar' %}">
            {% csrf_token %}

            <div class="profile-modal-avatar-preview">
                {% if user.profile.avatar %}
                    <img id="modalAvatarPreviewImg" src="{{ user.profile.avatar.url }}" alt="Prévia da Foto de perfil" class="profile-modal-img">
                {% elif user.avatar %}
                    <img id="modalAvatarPreviewImg" src="{{ user.avatar.url }}" alt="Prévia da Foto de perfil" class="profile-modal-img">
                {% else %}
                    <div id="modalAvatarPreviewDefault" class="profile-modal-default-avatar">
                        {{ user.get_full_name|default:user.username|first|upper }}
                    </div>
                {% endif %}
            </div>

            <input 
                type="file" 
                id="avatarFileInput" 
                name="avatar" 
                accept="image/*" 
                style="display: none;">             <button type="button" id="changeImageBtn" class="profile-modal-action-btn">Alterar Imagem</button>

                        <button type="submit" id="saveImageBtn" class="profile-confirm-btn" style="display: none; margin-top: 15px;">Salvar Foto</button>
        
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function formatPhone(input) {
        let value = input.value.replace(/\D/g, "");
        let formattedValue = '';

        if (value.length > 0) formattedValue = '(' + value.substring(0, 2);
        if (value.length > 2) formattedValue += ') ' + value.substring(2, 7);
        if (value.length > 7) formattedValue += '-' + value.substring(7, 11);
        
        input.value = formattedValue.substring(0, 15);
    }

    function isNumberKey(evt) {
        const c = evt.which ? evt.which : evt.keyCode;
        return !(c > 31 && (c < 48 || c > 57));
    }

    function setupPasswordToggle(toggleId, inputId) {
        const toggleButton = document.getElementById(toggleId);
        const passwordInput = document.getElementById(inputId);

        toggleButton.addEventListener('click', function() {
            const type = passwordInput.type === 'password' ? 'text' : 'password';
            passwordInput.type = type;

            const icon = this.querySelector('i');
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        });
    }

    // Configurar toggles de senha
    setupPasswordToggle('toggleSenhaAntiga', 'senhaAntigaInput');
    setupPasswordToggle('toggleSenhaNova', 'senhaNovaInput');

    // Configurar tags de interesse
    document.querySelectorAll('.profile-interest-tag').forEach(button => {
        button.addEventListener('click', function() {
            this.classList.toggle('profile-interest-selected');
        });
    });


// Seleção de novos elementos do modal
const modal = document.getElementById('avatarEditModal');
const btnCamera = document.querySelector('.profile-edit-avatar-btn');
const spanClose = document.querySelector('.profile-modal-close-btn');

const avatarFileInput = document.getElementById('avatarFileInput');
const changeImageBtn = document.getElementById('changeImageBtn');
const saveImageBtn = document.getElementById('saveImageBtn');

// Elementos de pré-visualização (não precisa declarar aqui se for buscar dentro da função)
const avatarPreviewContainer = document.querySelector('.profile-modal-avatar-preview');

// --- Lógica de Abertura e Fechamento do Modal (Existente) ---
btnCamera.addEventListener('click', function() {
    modal.style.display = 'block';
    // Oculta o botão Salvar ao abrir, até que um novo arquivo seja selecionado
    saveImageBtn.style.display = 'none'; 
});

spanClose.addEventListener('click', function() {
    modal.style.display = 'none';
    // Opcional: Limpar o input se o usuário fechar o modal
    avatarFileInput.value = ""; 
});

window.addEventListener('click', function(event) {
    if (event.target == modal) {
        modal.style.display = 'none';
        avatarFileInput.value = ""; 
    }
});

// --- NOVO: Lógica de Upload de Arquivo CORRIGIDA ---

// 1. Conecta o botão de "Alterar Imagem" ao input escondido
changeImageBtn.addEventListener('click', function() {
    // Clica no input de arquivo, abrindo a janela de seleção
    avatarFileInput.click(); 
});

// 2. Pré-visualiza a imagem e mostra o botão de Salvar
avatarFileInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    
    if (file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            // Verifica se o placeholder DIV existe e o remove se a imagem for carregada
            let defaultAvatarElement = document.getElementById('modalAvatarPreviewDefault');
            if (defaultAvatarElement) {
                defaultAvatarElement.remove();
            }
            
            // Tenta usar a tag <img> existente ou cria uma nova
            let imgElement = document.getElementById('modalAvatarPreviewImg');
            
            if (!imgElement) {
                imgElement = document.createElement('img');
                imgElement.id = 'modalAvatarPreviewImg';
                imgElement.alt = 'Prévia da nova foto';
                imgElement.classList.add('profile-modal-img');
                avatarPreviewContainer.appendChild(imgElement);
            }
            
            // Atualiza a fonte da imagem
            imgElement.src = e.target.result;
            
            // Exibe o botão de salvar
            saveImageBtn.style.display = 'block';
        };
        
        reader.readAsDataURL(file);
    } else {
        // Se o usuário cancelar a seleção, esconde o botão de Salvar
        saveImageBtn.style.display = 'none';
    }
});
</script>
{% endblock %}