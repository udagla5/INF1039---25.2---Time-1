{% extends "base.html" %}
{% load static %}

{% block title %}Editar Perfil | NOP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/perfil_aluno_style.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
{% endblock %}

{% block content %}
<div class="profile-edit-container">
    <header class="profile-edit-header">
        <div class="profile-header-content">
            <div class="profile-header-text">
                <h1>Editar Perfil</h1>
                <p>Configure a sua experiência NOP</p>
            </div>
        </div>
    </header>

    <main class="profile-edit-main">
        <div class="profile-avatar-section">
            <div class="profile-avatar-large">
                
                {% if user.foto_perfil %}
                    <img src="{{ user.foto_perfil.url }}" alt="Foto de perfil" class="profile-avatar-img">
                {% else %}
                    <div class="profile-default-avatar">
                        {{ user.get_full_name|default:user.username|first|upper }}
                    </div>
                {% endif %}
                
                <button class="profile-edit-avatar-btn" aria-label="Editar Foto de Perfil">
                    <i class="fa-solid fa-camera"></i>
                </button>
            </div>
        </div>

        <div class="profile-edit-form-box">
            <form class="profile-edit-form" method="POST">
                {% csrf_token %}
                
                <div class="profile-form-section">
                    <h3 class="profile-section-title">Informações Pessoais</h3>
                    
                    <div class="profile-form-group">
                        <label for="username">Seu username</label>
                        <!-- O campo username é apenas para exibição e é desabilitado -->
                        <input type="text" id="username" name="username" value="{{ user.username }}" disabled>
                        <small style="color: #666; font-size: 12px;">O username não pode ser alterado</small>
                    </div>

                    {% for field in form %}
                        {% if field.name not in 'interesses' %}
                        <div class="profile-form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                {% for error in field.errors %}
                                    <span class="error-message" style="color: #dc3545; font-size: 12px;">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="profile-section-divider"></div>

                {% if not is_professor %}
                <div class="profile-form-section">
                    <h3 class="profile-section-title">Meus Interesses</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Selecione suas áreas de interesse para receber oportunidades personalizadas</p>
                    
                    <!-- NOVO CONTAINER DE INTERESSES (CHIPS) -->
                    <div class="profile-interesses-container"> 
                        {% for checkbox in form.interesses %}
                            <!-- Ajustado para usar a nova classe e estrutura de chip -->
                            <div class="profile-interesse-item">
                                {{ checkbox.tag }} 
                                <label for="{{ checkbox.id_for_label }}" style="cursor: pointer; margin: 0;">
                                    {{ checkbox.choice_label }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% if form.interesses.errors %}
                        <span class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 5px;">{{ form.interesses.errors.0 }}</span>
                    {% endif %}
                </div>

                <div class="profile-section-divider"></div>
                {% endif %}

                <div class="profile-form-section">
                    <h3 class="profile-section-title">Segurança</h3>
                    <!-- OBS: Campos de senha não estão vinculados ao ModelForm, precisam de manipulação customizada no Django para salvar -->
                    <div class="profile-form-group profile-password-group">
                        <label>Senha atual</label>
                        <input type="password" id="senhaAntigaInput" name="senha-antiga" placeholder="Digite a sua senha atual">
                        <button type="button" class="profile-toggle-password-btn" id="toggleSenhaAntiga"><i class="fa-solid fa-eye-slash"></i></button>
                    </div>

                    <div class="profile-form-group profile-password-group">
                        <label>Nova senha</label>
                        <input type="password" id="senhaNovaInput" name="senha-nova" placeholder="Digite a sua nova senha">
                        <button type="button" class="profile-toggle-password-btn" id="toggleSenhaNova"><i class="fa-solid fa-eye-slash"></i></button>
                    </div>
                </div>

                <div class="profile-section-divider"></div>

                <button type="submit" class="profile-confirm-btn">Confirmar mudanças</button>
            </form>
        </div>
    </main>
</div>

<!-- Modal de Edição de Avatar (mantido inalterado) -->
<div id="avatarEditModal" class="profile-modal">
    <div class="profile-modal-content">
        <span class="profile-modal-close-btn">&times;</span>
        <h3 class="profile-modal-title">Sua Foto de Perfil</h3>

        <form id="avatarUploadForm" method="POST" enctype="multipart/form-data" action="{% url 'upload_avatar' %}">
            {% csrf_token %}

            <div class="profile-modal-avatar-preview">
                {% if user.foto_perfil %}
                    <img id="modalAvatarPreviewImg" src="{{ user.foto_perfil.url }}" alt="Prévia" class="profile-modal-img">
                {% else %}
                    <div id="modalAvatarPreviewDefault" class="profile-modal-default-avatar">
                        {{ user.get_full_name|default:user.username|first|upper }}
                    </div>
                {% endif %}
            </div>

            <input type="file" id="avatarFileInput" name="avatar" accept="image/*" style="display: none;">
            
            <button type="button" id="changeImageBtn" class="profile-modal-action-btn">Alterar Imagem</button>
            <button type="submit" id="saveImageBtn" class="profile-confirm-btn" style="display: none; margin-top: 15px;">Salvar Foto</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // Formatação de telefone
        const telefoneInput = document.getElementById('id_telefone');
        if (telefoneInput) {
            telefoneInput.addEventListener('input', function() {
                let value = this.value.replace(/\D/g, "");
                let formattedValue = '';
                if (value.length > 0) formattedValue = '(' + value.substring(0, 2);
                if (value.length > 2) formattedValue += ') ' + value.substring(2, 7);
                if (value.length > 7) formattedValue += '-' + value.substring(7, 11);
                this.value = formattedValue.substring(0, 15);
            });
        }


        // Toggle de senha (Mantido)
        function setupPasswordToggle(toggleId, inputId) {
            const toggleButton = document.getElementById(toggleId);
            const passwordInput = document.getElementById(inputId);
            if(toggleButton && passwordInput){
                toggleButton.addEventListener('click', function() {
                    const type = passwordInput.type === 'password' ? 'text' : 'password';
                    passwordInput.type = type;
                    const icon = this.querySelector('i');
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
            }
        }
        setupPasswordToggle('toggleSenhaAntiga', 'senhaAntigaInput');
        setupPasswordToggle('toggleSenhaNova', 'senhaNovaInput');

        // --- LÓGICA DE SELEÇÃO DOS CHIPS DE INTERESSE ---
        const interesseItems = document.querySelectorAll('.profile-interesse-item');
        
        interesseItems.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            const label = item.querySelector('label');

            if (checkbox && label) {
                
                // 1. Função para garantir que o estilo CSS seja aplicado no carregamento (se já estiver checked)
                function updateChipAppearance() {
                    if (checkbox.checked) {
                        label.classList.add('selected-chip');
                    } else {
                        label.classList.remove('selected-chip');
                    }
                }
                
                // 2. Manipula o clique no item (necessário porque o input está oculto)
                item.addEventListener('click', (e) => {
                    // Impede que o clique na label padrão dispare duas vezes
                    if (e.target !== checkbox && e.target !== label) {
                        checkbox.checked = !checkbox.checked;
                        // Dispara o evento 'change' para que o CSS :checked seja reavaliado
                        checkbox.dispatchEvent(new Event('change')); 
                    }
                });
                
                // 3. Garante que o CSS mude o estilo ao interagir (em navegadores que não suportam :checked + label perfeitamente)
                checkbox.addEventListener('change', updateChipAppearance);
                
                // 4. Inicializa o estado visual
                updateChipAppearance(); 
            }
        });


        // --- LÓGICA DO MODAL DE UPLOAD (Mantido) ---
        const modal = document.getElementById('avatarEditModal');
        const btnCamera = document.querySelector('.profile-edit-avatar-btn');
        const spanClose = document.querySelector('.profile-modal-close-btn');
        const avatarFileInput = document.getElementById('avatarFileInput');
        const changeImageBtn = document.getElementById('changeImageBtn');
        const saveImageBtn = document.getElementById('saveImageBtn');
        const avatarPreviewContainer = document.querySelector('.profile-modal-avatar-preview');

        if(btnCamera) {
            btnCamera.addEventListener('click', () => { 
                modal.style.display = 'block'; 
                // Inicialmente esconde o botão de salvar
                saveImageBtn.style.display = 'none'; 
            });
        }
        if(spanClose) {
            spanClose.addEventListener('click', () => { modal.style.display = 'none'; });
        }
        window.addEventListener('click', (event) => {
            if (event.target == modal) modal.style.display = 'none';
        });

        if(changeImageBtn) {
            changeImageBtn.addEventListener('click', () => avatarFileInput.click());
        }

        if(avatarFileInput) {
            avatarFileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        let defaultAvatar = document.getElementById('modalAvatarPreviewDefault');
                        if (defaultAvatar) defaultAvatar.remove();

                        let imgElement = document.getElementById('modalAvatarPreviewImg');
                        if (!imgElement) {
                            imgElement = document.createElement('img');
                            imgElement.id = 'modalAvatarPreviewImg';
                            imgElement.classList.add('profile-modal-img');
                            avatarPreviewContainer.appendChild(imgElement);
                        }
                        imgElement.src = e.target.result;
                        saveImageBtn.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });
</script>
{% endblock %}